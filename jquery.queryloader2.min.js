(function(e){function t(e){this.parent=e;this.container;this.loadbar;this.percentageContainer}function n(e){this.toPreload=[];this.parent=e;this.container}function r(e){this.element;this.parent=e}function i(r,i){this.element=r;this.$element=e(r);this.options=i;this.foundUrls=[];this.destroyed=false;this.imageCounter=0;this.imageDone=0;this.alreadyLoaded=false;this.preloadContainer=new n(this);this.overlayLoader=new t(this);this.defaultOptions={onComplete:function(){},onLoadComplete:function(){},backgroundColor:"#000",barColor:"#fff",overlayId:"qLoverlay",barHeight:1,percentage:false,deepSearch:true,completeAnimation:"fade",minimumTime:500,fontFamily:"kelson_sans_regular-webfont"};this.init()}t.prototype.createOverlay=function(){var t="absolute";if(this.parent.element.tagName.toLowerCase()=="body"){t="fixed"}else{var n=this.parent.$element.css("position");if(n!="fixed"||n!="absolute"){this.parent.$element.css("position","relative")}}this.container=e("<div id='"+this.parent.options.overlayId+"'></div>").css({width:"100%",height:"100%",backgroundColor:this.parent.options.backgroundColor,backgroundPosition:"fixed",position:t,zIndex:666999,top:0,left:0}).appendTo(this.parent.$element);this.loadbar=e("<div id='qLbar'></div>").css({height:this.parent.options.barHeight+"px",marginTop:"-"+this.parent.options.barHeight/2+"px",backgroundColor:this.parent.options.barColor,width:"0%",position:"absolute",top:"50%"}).appendTo(this.container);if(this.parent.options.percentage==true){this.percentageContainer=e("<div id='qLpercentage'></div>").text("0%").css({height:"40px",width:"100px",position:"absolute",fontSize:"3em",fontFamily:this.parent.options.fontFamily,top:"50%",left:"50%",marginTop:"-"+(59+this.parent.options.barHeight)+"px",textAlign:"center",marginLeft:"-50px",color:this.parent.options.barColor}).appendTo(this.container)}if(!this.parent.preloadContainer.toPreload.length||this.parent.alreadyLoaded==true){this.parent.destroyContainers()}};t.prototype.updatePercentage=function(e){this.loadbar.stop().animate({width:e+"%",minWidth:e+"%"},200);if(this.parent.options.percentage==true){this.percentageContainer.text(Math.ceil(e)+"%")}};n.prototype.create=function(){this.container=e("<div></div>").appendTo("body").css({display:"none",width:0,height:0,overflow:"hidden"});this.processQueue()};n.prototype.processQueue=function(){for(var e=0;this.toPreload.length>e;e++){if(!this.parent.destroyed){this.preloadImage(this.toPreload[e])}}};n.prototype.addImage=function(e){this.toPreload.push(e)};n.prototype.preloadImage=function(e){var t=new r;t.addToPreloader(this,e);t.bindLoadEvent()};r.prototype.addToPreloader=function(t,n){this.element=e("<img />").attr("src",n);this.element.appendTo(t.container);this.parent=t.parent};r.prototype.bindLoadEvent=function(){this.parent.imageCounter++;var e=this.element.attr("src");this.element.removeAttr("src");var t=this;setTimeout(function(){t.element.on("load error",t,function(e){e.data.completeLoading()});t.element.attr("src",e)},1)};r.prototype.completeLoading=function(){this.parent.imageDone++;var e=this.parent.imageDone/this.parent.imageCounter*100;this.parent.overlayLoader.updatePercentage(e);if(this.parent.imageDone==this.parent.imageCounter){this.parent.endLoader()}};i.prototype.init=function(){this.options=e.extend({},this.defaultOptions,this.options);var t=this.findImageInElement(this.element);if(this.options.deepSearch==true){var n=this.$element.find("*:not(script)");for(var r=0;r<n.length;r++){this.findImageInElement(n[r])}}this.preloadContainer.create();this.overlayLoader.createOverlay()};i.prototype.findImageInElement=function(t){var n="";var i=e(t);var s="normal";if(i.css("background-image")!="none"){n=i.css("background-image");s="background"}else if(typeof i.attr("src")!="undefined"&&t.nodeName.toLowerCase()=="img"){n=i.attr("src")}if(!this.hasGradient(n)){n=this.stripUrl(n);var o=n.split(", ");for(var u=0;u<o.length;u++){if(this.validUrl(o[u])&&this.urlIsNew(o[u])){var a="";if(this.isIE()||this.isOpera()){a="?rand="+Math.random();this.preloadContainer.addImage(o[u]+a)}else{if(s=="background"){this.preloadContainer.addImage(o[u]+a)}else{var f=new r(this);f.element=i;f.bindLoadEvent()}}this.foundUrls.push(o[u])}}}};i.prototype.hasGradient=function(e){if(e.indexOf("gradient")==-1){return false}else{return true}};i.prototype.stripUrl=function(e){e=e.replace(/url\(\"/g,"");e=e.replace(/url\(/g,"");e=e.replace(/\"\)/g,"");e=e.replace(/\)/g,"");return e};i.prototype.isIE=function(){return navigator.userAgent.match(/msie/i)};i.prototype.isOpera=function(){return navigator.userAgent.match(/Opera/i)};i.prototype.validUrl=function(e){if(e.length>0&&!e.match(/^(data:)/i)){return true}else{return false}};i.prototype.urlIsNew=function(e){if(this.foundUrls.indexOf(e)==-1){return true}else{return false}};i.prototype.destroyContainers=function(){this.destroyed=true;this.preloadContainer.container.remove();this.overlayLoader.container.remove()};i.prototype.endLoader=function(){this.destroyed=true;this.onLoadComplete()};i.prototype.onLoadComplete=function(){this.options.onLoadComplete();if(this.options.completeAnimation=="grow"){var t=this.options.minimumTime;this.overlayLoader.loadbar[0].parent=this;this.overlayLoader.loadbar.stop().animate({width:"100%"},t,function(){e(this).animate({top:"0%",width:"100%",height:"100%"},500,function(){this.parent.overlayLoader.container[0].parent=this.parent;this.parent.overlayLoader.container.fadeOut(500,function(){this.parent.destroyContainers();this.parent.options.onComplete()})})})}else{this.overlayLoader.container[0].parent=this;this.overlayLoader.container.fadeOut(500,function(){this.parent.destroyContainers();this.parent.options.onComplete()})}};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var t=this.length>>>0;var n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n);if(n<0)n+=t;for(;n<t;n++){if(n in this&&this[n]===e)return n}return-1}}e.fn.queryLoader2=function(e){return this.each(function(){new i(this,e)})}})(jQuery)